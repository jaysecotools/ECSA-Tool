<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecological & Cultural Site Inspector | AHCECR309</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Add compressor for images -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.0/dist/browser-image-compression.min.js"></script>
    <!-- Add manifest for PWA -->
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#4CAF50"/>
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --secondary: #FFC107;
            --secondary-dark: #FFA000;
            --text: #333333;
            --text-light: #666666;
            --bg: #FFFFFF;
            --bg-secondary: #F5F5F5;
            --border: #E0E0E0;
            --error: #F44336;
            --warning: #FF9800;
            --info: #2196F3;
            --success: #4CAF50;
        }

        [data-theme="dark"] {
            --primary: #81C784;
            --primary-dark: #66BB6A;
            --secondary: #FFD54F;
            --secondary-dark: #FFCA28;
            --text: #E0E0E0;
            --text-light: #B0B0B0;
            --bg: #121212;
            --bg-secondary: #1E1E1E;
            --border: #424242;
            --error: #E57373;
            --warning: #FFB74D;
            --info: #64B5F6;
            --success: #81C784;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text);
            background-color: var(--bg);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-toggle {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 5px;
            display: flex;
            gap: 5px;
            margin-left: 15px;
        }

        .mode-toggle button {
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            background: transparent;
            color: var(--text-light);
        }

        .mode-toggle button.active {
            background: var(--primary);
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            background-color: var(--bg-secondary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: var(--border);
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
            padding: 25px;
            background-color: var(--bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
        }

        h3 {
            margin: 15px 0 10px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .help-text {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 5px;
        }

        input[type="text"],
        input[type="date"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: var(--bg);
            color: var(--text);
            font-family: inherit;
            transition: border 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input {
            width: auto;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: var(--border);
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .map-container {
            height: 300px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            border: 1px dashed var(--border);
        }

        .photo-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
        }

        .photo-upload:hover {
            border-color: var(--primary);
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border);
            position: relative;
        }

        .photo-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(244, 67, 54, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .risk-cell {
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .risk-cell:hover {
            transform: scale(1.05);
        }

        .risk-low {
            background-color: #E8F5E9;
            color: #2E7D32;
        }

        .risk-medium {
            background-color: #FFF8E1;
            color: #F57F17;
        }

        .risk-high {
            background-color: #FFEBEE;
            color: #C62828;
        }

        .risk-extreme {
            background-color: #F3E5F5;
            color: #6A1B9A;
        }

        .selected-risk {
            font-weight: bold;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .habitat-condition {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }

        .condition-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .condition-item:hover {
            background-color: var(--border);
        }

        .condition-item.selected {
            background-color: var(--primary);
            color: white;
        }

        .condition-item .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .report-preview {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .report-section {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .report-section h3 {
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .report-table th, .report-table td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: left;
        }

        .report-table th {
            background-color: var(--bg-secondary);
        }

        .signature-pad {
            border: 1px solid var(--border);
            border-radius: 4px;
            margin: 15px 0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--bg-secondary);
            color: var(--text);
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--border);
            font-size: 14px;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: var(--info);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            margin-left: 5px;
            cursor: help;
        }

        .quiz-question {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
        }

        .quiz-options {
            margin-top: 10px;
        }

        .quiz-option {
            margin-bottom: 8px;
        }

        .quiz-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .correct {
            background-color: #E8F5E9;
            color: #2E7D32;
        }

        .incorrect {
            background-color: #FFEBEE;
            color: #C62828;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .resource-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .resource-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .resource-card h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .resource-card p {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 5px;
            background-color: var(--bg-secondary);
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-complete {
            background-color: #E8F5E9;
            color: #2E7D32;
        }

        .status-incomplete {
            background-color: #FFF8E1;
            color: #F57F17;
        }

        /* Leaflet map styles */
        #map-container, #main-map {
            z-index: 1;
        }

        .leaflet-container {
            background-color: var(--bg);
        }

        .leaflet-control-attribution {
            background-color: var(--bg) !important;
            color: var(--text) !important;
        }

        .leaflet-bar {
            background-color: var(--bg) !important;
        }

        .leaflet-bar a {
            background-color: var(--bg) !important;
            color: var(--text) !important;
            border-bottom-color: var(--border) !important;
        }

        .leaflet-bar a:hover {
            background-color: var(--bg-secondary) !important;
        }

        .location-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .location-btn:hover {
            background-color: var(--bg-secondary);
        }

        /* PDF Options Styling */
        .pdf-options {
            background-color: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .pdf-options h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .pdf-option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        .pdf-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-option label {
            margin-bottom: 0;
        }

        .pdf-quality-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pdf-quality-selector button {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background-color: var(--bg);
            cursor: pointer;
        }

        .pdf-quality-selector button.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        .pdf-cover-styles {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .pdf-cover-style {
            border: 2px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pdf-cover-style:hover {
            border-color: var(--primary);
        }

        .pdf-cover-style.selected {
            border-color: var(--primary);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .pdf-cover-style .preview {
            width: 100%;
            height: 60px;
            margin-bottom: 5px;
            background-size: cover;
            background-position: center;
        }

        .pdf-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: var(--bg-secondary);
            display: none;
        }

        .pdf-status.active {
            display: block;
        }

        .pdf-progress {
            height: 5px;
            background-color: var(--border);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .pdf-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .validation-error {
            color: var(--error);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .habitat-condition {
                flex-direction: column;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 10px;
            }

            .tab {
                padding: 8px 15px;
                font-size: 14px;
            }

            .pdf-cover-styles {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* Dark mode specific styles */
        [data-theme="dark"] .risk-low {
            background-color: #1B5E20;
            color: #E8F5E9;
        }

        [data-theme="dark"] .risk-medium {
            background-color: #FF6F00;
            color: #FFF8E1;
        }

        [data-theme="dark"] .risk-high {
            background-color: #C62828;
            color: #FFEBEE;
        }

        [data-theme="dark"] .risk-extreme {
            background-color: #6A1B9A;
            color: #F3E5F5;
        }

        [data-theme="dark"] .report-table th {
            background-color: #1E1E1E;
        }

        [data-theme="dark"] .correct {
            background-color: #1B5E20;
            color: #E8F5E9;
        }

        [data-theme="dark"] .incorrect {
            background-color: #C62828;
            color: #FFEBEE;
        }

        [data-theme="dark"] .photo-remove {
            background-color: rgba(198, 40, 40, 0.8);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <header>
                <div class="logo">Ecological & Cultural Site Inspector</div>
                <div>
                    <button class="theme-toggle" @click="toggleTheme">
                        <span v-if="darkMode">☀️ Light Mode</span>
                        <span v-else>🌙 Dark Mode</span>
                    </button>
                    <div class="mode-toggle">
                        <button :class="{active: learnerMode}" @click="learnerMode = true">Learner</button>
                        <button :class="{active: !learnerMode}" @click="learnerMode = false">Professional</button>
                    </div>
                </div>
            </header>

            <div class="progress-bar">
                <div class="progress-fill" :style="{width: progress + '%'}"></div>
            </div>

            <div class="tabs">
                <div v-for="(tab, index) in tabs" :key="index" 
                     class="tab" 
                     :class="{active: activeTab === index}"
                     @click="activeTab = index">
                    {{ tab.name }}
                    <span v-if="tab.complete" class="status-badge status-complete">✓</span>
                    <span v-else class="status-badge status-incomplete">!</span>
                </div>
            </div>

            <!-- Site Information Tab -->
            <div class="tab-content" :class="{active: activeTab === 0}">
                <h2>Site Information</h2>
                
                <div class="form-group">
                    <label for="inspection-date">Inspection Date</label>
                    <input type="date" id="inspection-date" v-model="siteInfo.inspectionDate">
                </div>

                <div class="form-group">
                    <label for="site-name">Site Name/Location</label>
                    <input type="text" id="site-name" v-model="siteInfo.siteName" placeholder="Enter site name or address">
                </div>

                <div class="form-group">
                    <label for="site-coords">Site Coordinates (Latitude, Longitude)</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="lat" v-model="siteInfo.latitude" placeholder="Latitude" @blur="validateCoordinates">
                            <div class="validation-error" :class="{show: coordErrors.latitude}">Please enter a valid latitude (-90 to 90)</div>
                        </div>
                        <div class="form-group">
                            <input type="text" id="long" v-model="siteInfo.longitude" placeholder="Longitude" @blur="validateCoordinates">
                            <div class="validation-error" :class="{show: coordErrors.longitude}">Please enter a valid longitude (-180 to 180)</div>
                        </div>
                    </div>
                    <p class="help-text">Example: -33.8688, 151.2093 or use the map below to select location</p>
                </div>

                <div class="form-group">
                    <label>Site Map</label>
                    <div class="map-container" id="main-map">
                        <!-- Map will be initialized here -->
                    </div>
                    <button class="btn btn-secondary" @click="locateUser">Use My Location</button>
                    <div class="validation-error" :class="{show: coordErrors.map}">Please select a location on the map</div>
                </div>

                <h3>Client/Landholder Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-name">Name</label>
                        <input type="text" id="client-name" v-model="siteInfo.clientName">
                    </div>
                    <div class="form-group">
                        <label for="client-org">Organization</label>
                        <input type="text" id="client-org" v-model="siteInfo.clientOrg">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="client-email">Email</label>
                        <input type="email" id="client-email" v-model="siteInfo.clientEmail">
                    </div>
                    <div class="form-group">
                        <label for="client-phone">Phone</label>
                        <input type="tel" id="client-phone" v-model="siteInfo.clientPhone">
                    </div>
                </div>

                <div class="form-group">
                    <label for="site-description">Site Description</label>
                    <textarea id="site-description" v-model="siteInfo.siteDescription" placeholder="Brief description of the site including size, general condition, and notable features"></textarea>
                    <p class="help-text">Include information about access points, terrain, and any existing infrastructure</p>
                </div>

                <div class="form-group">
                    <label>Site Photos</label>
                    <div class="photo-upload" @click="triggerPhotoUpload('site')">
                        <p>Click to upload photos or drag and drop files here</p>
                        <input type="file" id="photo-upload" multiple accept="image/*" style="display: none;" @change="handlePhotoUpload($event, 'site')">
                    </div>
                    <div class="photo-preview">
                        <div v-for="(photo, index) in siteInfo.photos" :key="index" class="photo-thumbnail-container">
                            <img :src="photo.url" class="photo-thumbnail" @click="viewPhoto(photo)">
                            <button class="photo-remove" @click.stop="removePhoto('site', index)">×</button>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" @click="saveInspection">Save Progress</button>
                    <button class="btn btn-primary" @click="validateAndNextTab">Continue to Ecological Assessment</button>
                </div>
            </div>

            <!-- Ecological Assessment Tab -->
            <div class="tab-content" :class="{active: activeTab === 1}">
                <h2>Ecological Assessment</h2>
                
                <div class="form-group">
                    <label for="veg-community">Vegetation Community/Type</label>
                    <select id="veg-community" v-model="ecological.vegetationCommunity">
                        <option value="">Select vegetation community</option>
                        <option v-for="(community, index) in vegetationCommunities" :key="index" :value="community">{{ community }}</option>
                    </select>
                    <p class="help-text">If unsure, refer to local vegetation classification guides</p>
                </div>

                <div class="form-group">
                    <label>Threatened Species Present</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" v-for="(species, index) in threatenedSpecies" :key="index">
                            <input type="checkbox" :id="'species-'+index" v-model="ecological.threatenedSpecies[species]">
                            <label :for="'species-'+index">{{ species }}</label>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" @click="addThreatenedSpecies">Add Custom Species</button>
                </div>

                <div class="form-group">
                    <label>Invasive Species/Weeds Present</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" v-for="(weed, index) in invasiveSpecies" :key="index">
                            <input type="checkbox" :id="'weed-'+index" v-model="ecological.invasiveSpecies[weed]">
                            <label :for="'weed-'+index">{{ weed }}</label>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" @click="addInvasiveSpecies">Add Custom Weed</button>
                </div>

                <div class="form-group">
                    <label>Habitat Condition</label>
                    <div class="habitat-condition">
                        <div class="condition-item" 
                             :class="{selected: ecological.habitatCondition === 'excellent'}"
                             @click="ecological.habitatCondition = 'excellent'">
                            <div class="icon">🌿</div>
                            <div>Excellent</div>
                            <p class="help-text">Minimal disturbance, high biodiversity</p>
                        </div>
                        <div class="condition-item" 
                             :class="{selected: ecological.habitatCondition === 'good'}"
                             @click="ecological.habitatCondition = 'good'">
                            <div class="icon">🌱</div>
                            <div>Good</div>
                            <p class="help-text">Some disturbance but functioning well</p>
                        </div>
                        <div class="condition-item" 
                             :class="{selected: ecological.habitatCondition === 'fair'}"
                             @click="ecological.habitatCondition = 'fair'">
                            <div class="icon">🍂</div>
                            <div>Fair</div>
                            <p class="help-text">Moderate disturbance, reduced function</p>
                        </div>
                        <div class="condition-item" 
                             :class="{selected: ecological.habitatCondition === 'poor'}"
                             @click="ecological.habitatCondition = 'poor'">
                            <div class="icon">🌵</div>
                            <div>Poor</div>
                            <p class="help-text">High disturbance, limited function</p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ecological-notes">Ecological Notes</label>
                    <textarea id="ecological-notes" v-model="ecological.notes" placeholder="Additional observations about flora, fauna, ecological values, and potential impacts"></textarea>
                    <p class="help-text">Include details about nesting sites, hollow-bearing trees, water sources, etc.</p>
                </div>

                <div class="form-group">
                    <label>Ecological Photos</label>
                    <div class="photo-upload" @click="triggerPhotoUpload('eco')">
                        <p>Click to upload photos or drag and drop files here</p>
                        <input type="file" id="eco-photo-upload" multiple accept="image/*" style="display: none;" @change="handlePhotoUpload($event, 'eco')">
                    </div>
                    <div class="photo-preview">
                        <div v-for="(photo, index) in ecological.photos" :key="index" class="photo-thumbnail-container">
                            <img :src="photo.url" class="photo-thumbnail" @click="viewPhoto(photo)">
                            <button class="photo-remove" @click.stop="removePhoto('eco', index)">×</button>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" @click="prevTab">Back to Site Information</button>
                    <button class="btn btn-secondary" @click="saveInspection">Save Progress</button>
                    <button class="btn btn-primary" @click="nextTab">Continue to Cultural Assessment</button>
                </div>
            </div>

            <!-- Cultural Assessment Tab -->
            <div class="tab-content" :class="{active: activeTab === 2}">
                <h2>Cultural Heritage Assessment</h2>
                
                <div class="form-group">
                    <label>Known Cultural Heritage Features</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" v-for="(feature, index) in culturalFeatures" :key="index">
                            <input type="checkbox" :id="'feature-'+index" v-model="cultural.knownFeatures[feature]">
                            <label :for="'feature-'+index">{{ feature }}</label>
                            <div class="tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltiptext">{{ getFeatureDescription(feature) }}</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" @click="addCulturalFeature">Add Custom Feature</button>
                </div>

                <div class="form-group">
                    <label for="cultural-significance">Cultural Significance Assessment</label>
                    <textarea id="cultural-significance" v-model="cultural.significance" placeholder="Describe the cultural significance of the site"></textarea>
                    <p class="help-text">Include information from Traditional Owners, historical records, or other sources</p>
                </div>

                <div class="form-group">
                    <label for="heritage-register">Heritage Register Check</label>
                    <select id="heritage-register" v-model="cultural.heritageRegister">
                        <option value="">Select status</option>
                        <option value="listed">Listed on heritage register</option>
                        <option value="potential">Potential heritage significance</option>
                        <option value="none">No known heritage listing</option>
                        <option value="unknown">Not checked</option>
                    </select>
                    <p class="help-text">Check with local Aboriginal Heritage Office or State Heritage Register</p>
                </div>

                <div class="form-group">
                    <label for="cultural-consultation">Consultation with Traditional Owners</label>
                    <select id="cultural-consultation" v-model="cultural.consultation">
                        <option value="">Select consultation status</option>
                        <option value="completed">Consultation completed</option>
                        <option value="pending">Consultation pending</option>
                        <option value="required">Consultation required</option>
                        <option value="not-applicable">Not applicable</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cultural-notes">Cultural Heritage Notes</label>
                    <textarea id="cultural-notes" v-model="cultural.notes" placeholder="Additional observations about cultural heritage values and potential impacts"></textarea>
                    <p class="help-text">Include details about any artifacts, scarred trees, ceremonial sites, etc.</p>
                </div>

                <div class="form-group">
                    <label>Cultural Heritage Photos</label>
                    <div class="photo-upload" @click="triggerPhotoUpload('cultural')">
                        <p>Click to upload photos or drag and drop files here</p>
                        <input type="file" id="cultural-photo-upload" multiple accept="image/*" style="display: none;" @change="handlePhotoUpload($event, 'cultural')">
                    </div>
                    <div class="photo-preview">
                        <div v-for="(photo, index) in cultural.photos" :key="index" class="photo-thumbnail-container">
                            <img :src="photo.url" class="photo-thumbnail" @click="viewPhoto(photo)">
                            <button class="photo-remove" @click.stop="removePhoto('cultural', index)">×</button>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" @click="prevTab">Back to Ecological Assessment</button>
                    <button class="btn btn-secondary" @click="saveInspection">Save Progress</button>
                    <button class="btn btn-primary" @click="nextTab">Continue to Risk Assessment</button>
                </div>
            </div>

            <!-- Risk Assessment Tab -->
            <div class="tab-content" :class="{active: activeTab === 3}">
                <h2>Site Condition & Risk Assessment</h2>
                
                <h3>Site Condition</h3>
                <div class="form-group">
                    <label for="soil-condition">Soil Condition</label>
                    <select id="soil-condition" v-model="riskAssessment.soilCondition">
                        <option value="">Select soil condition</option>
                        <option value="excellent">Excellent - stable, well-structured</option>
                        <option value="good">Good - minor compaction or erosion</option>
                        <option value="fair">Fair - some compaction or erosion</option>
                        <option value="poor">Poor - severe compaction or erosion</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="erosion-risk">Erosion Risk</label>
                    <select id="erosion-risk" v-model="riskAssessment.erosionRisk">
                        <option value="">Select erosion risk</option>
                        <option value="low">Low - minimal risk</option>
                        <option value="moderate">Moderate - some risk</option>
                        <option value="high">High - significant risk</option>
                        <option value="extreme">Extreme - immediate risk</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="disturbance-level">Existing Disturbance Level</label>
                    <select id="disturbance-level" v-model="riskAssessment.disturbanceLevel">
                        <option value="">Select disturbance level</option>
                        <option value="minimal">Minimal - pristine/near pristine</option>
                        <option value="low">Low - minor disturbance</option>
                        <option value="moderate">Moderate - some clearing or modification</option>
                        <option value="high">High - significantly modified</option>
                    </select>
                </div>

                <h3>Hazards Present</h3>
                <div class="form-group">
                    <div class="checkbox-group">
                        <div class="checkbox-item" v-for="(hazard, index) in hazards" :key="index">
                            <input type="checkbox" :id="'hazard-'+index" v-model="riskAssessment.hazards[hazard]">
                            <label :for="'hazard-'+index">{{ hazard }}</label>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" @click="addHazard">Add Custom Hazard</button>
                </div>

                <h3>Risk Assessment Matrix</h3>
                <p>Select the overall risk level based on likelihood and consequence:</p>
                <div class="risk-matrix">
                    <div v-for="(row, rowIndex) in riskMatrix" :key="rowIndex" class="risk-row">
                        <div v-for="(cell, cellIndex) in row" :key="cellIndex" 
                             class="risk-cell" 
                             :class="[cell.class, { 'selected-risk': riskAssessment.riskLevel === cell.value }]"
                             @click="riskAssessment.riskLevel = cell.value">
                            {{ cell.label }}
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="risk-notes">Risk Assessment Notes</label>
                    <textarea id="risk-notes" v-model="riskAssessment.notes" placeholder="Additional observations about site conditions, hazards, and risks"></textarea>
                    <p class="help-text">Include details about any immediate risks that need addressing</p>
                </div>

                <div class="form-group">
                    <label>Risk Photos</label>
                    <div class="photo-upload" @click="triggerPhotoUpload('risk')">
                        <p>Click to upload photos or drag and drop files here</p>
                        <input type="file" id="risk-photo-upload" multiple accept="image/*" style="display: none;" @change="handlePhotoUpload($event, 'risk')">
                    </div>
                    <div class="photo-preview">
                        <div v-for="(photo, index) in riskAssessment.photos" :key="index" class="photo-thumbnail-container">
                            <img :src="photo.url" class="photo-thumbnail" @click="viewPhoto(photo)">
                            <button class="photo-remove" @click.stop="removePhoto('risk', index)">×</button>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" @click="prevTab">Back to Cultural Assessment</button>
                    <button class="btn btn-secondary" @click="saveInspection">Save Progress</button>
                    <button class="btn btn-primary" @click="nextTab">Continue to Mitigation</button>
                </div>
            </div>

            <!-- Mitigation Actions Tab -->
            <div class="tab-content" :class="{active: activeTab === 4}">
                <h2>Recommended Mitigation Actions</h2>
                
                <div class="form-group">
                    <label>Ecological Mitigation Measures</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" v-for="(measure, index) in ecologicalMitigation" :key="index">
                            <input type="checkbox" :id="'eco-mit-'+index" v-model="mitigation.ecologicalMeasures[measure]">
                            <label :for="'eco-mit-'+index">{{ measure }}</label>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" @click="addEcologicalMitigation">Add Custom Measure</button>
                </div>

                <div class="form-group">
                    <label for="ecological-mit-details">Ecological Mitigation Details</label>
                    <textarea id="ecological-mit-details" v-model="mitigation.ecologicalDetails" placeholder="Specific details about ecological mitigation measures"></textarea>
                    <p class="help-text">Include timing considerations, methods, and monitoring requirements</p>
                </div>

                <div class="form-group">
                    <label>Cultural Heritage Mitigation Measures</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" v-for="(measure, index) in culturalMitigation" :key="index">
                            <input type="checkbox" :id="'cul-mit-'+index" v-model="mitigation.culturalMeasures[measure]">
                            <label :for="'cul-mit-'+index">{{ measure }}</label>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" @click="addCulturalMitigation">Add Custom Measure</button>
                </div>

                <div class="form-group">
                    <label for="cultural-mit-details">Cultural Mitigation Details</label>
                    <textarea id="cultural-mit-details" v-model="mitigation.culturalDetails" placeholder="Specific details about cultural heritage mitigation measures"></textarea>
                    <p class="help-text">Include consultation requirements, monitoring, and any necessary permits</p>
                </div>

                <div class="form-group">
                    <label>General Site Mitigation Measures</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" v-for="(measure, index) in generalMitigation" :key="index">
                            <input type="checkbox" :id="'gen-mit-'+index" v-model="mitigation.generalMeasures[measure]">
                            <label :for="'gen-mit-'+index">{{ measure }}</label>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" @click="addGeneralMitigation">Add Custom Measure</button>
                </div>

                <div class="form-group">
                    <label for="general-mit-details">General Mitigation Details</label>
                    <textarea id="general-mit-details" v-model="mitigation.generalDetails" placeholder="Specific details about general site mitigation measures"></textarea>
                    <p class="help-text">Include erosion control, access management, and other site-specific measures</p>
                </div>

                <div class="form-group">
                    <label for="monitoring-req">Monitoring Requirements</label>
                    <textarea id="monitoring-req" v-model="mitigation.monitoring" placeholder="Describe any monitoring requirements for the site"></textarea>
                    <p class="help-text">Include frequency, methods, and responsible parties</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" @click="prevTab">Back to Risk Assessment</button>
                    <button class="btn btn-secondary" @click="saveInspection">Save Progress</button>
                    <button class="btn btn-primary" @click="nextTab">Continue to Report</button>
                </div>
            </div>

            <!-- Report Generator Tab -->
            <div class="tab-content" :class="{active: activeTab === 5}">
                <h2>Report Generator</h2>
                
                <div class="form-group">
                    <label for="inspector-name">Inspector Name</label>
                    <input type="text" id="inspector-name" v-model="report.inspectorName">
                </div>

                <div class="form-group">
                    <label for="inspector-org">Inspector Organization</label>
                    <input type="text" id="inspector-org" v-model="report.inspectorOrg">
                </div>

                <div class="form-group">
                    <label for="inspector-qualifications">Inspector Qualifications</label>
                    <input type="text" id="inspector-qualifications" v-model="report.inspectorQualifications" placeholder="Relevant qualifications or certifications">
                </div>

                <div class="form-group">
                    <label>Inspector Signature</label>
                    <div class="signature-pad" ref="signaturePad">
                        <canvas width="400" height="200" style="border: 1px solid var(--border); background-color: var(--bg);"></canvas>
                    </div>
                    <button class="btn btn-secondary" @click="clearSignature" style="margin-top: 10px;">Clear Signature</button>
                </div>

                <div class="form-group">
                    <label for="report-notes">Additional Report Notes</label>
                    <textarea id="report-notes" v-model="report.notes" placeholder="Any additional comments for the report"></textarea>
                </div>

                <div class="pdf-options">
                    <h4>PDF Report Options</h4>
                    
                    <div class="pdf-option-group">
                        <div class="pdf-option">
                            <input type="checkbox" id="include-photos" v-model="report.includePhotos">
                            <label for="include-photos">Include photos in report</label>
                        </div>
                        <div class="pdf-option">
                            <input type="checkbox" id="include-details" v-model="report.includeDetails" checked>
                            <label for="include-details">Include all details</label>
                        </div>
                        <div class="pdf-option">
                            <input type="checkbox" id="exclude-empty" v-model="report.excludeEmpty" checked>
                            <label for="exclude-empty">Exclude empty sections</label>
                        </div>
                        <div class="pdf-option">
                            <input type="checkbox" id="table-of-contents" v-model="report.tableOfContents" checked>
                            <label for="table-of-contents">Include table of contents</label>
                        </div>
                        <div class="pdf-option">
                            <input type="checkbox" id="header-footer" v-model="report.headerFooter" checked>
                            <label for="header-footer">Include headers/footers</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Image Quality</label>
                        <div class="pdf-quality-selector">
                            <button :class="{active: report.imageQuality === 'low'}" @click="report.imageQuality = 'low'">Low</button>
                            <button :class="{active: report.imageQuality === 'medium'}" @click="report.imageQuality = 'medium'">Medium</button>
                            <button :class="{active: report.imageQuality === 'high'}" @click="report.imageQuality = 'high'">High</button>
                        </div>
                        <p class="help-text">Higher quality increases file size</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Cover Page Style</label>
                        <div class="pdf-cover-styles">
                            <div class="pdf-cover-style" 
                                 :class="{selected: report.coverStyle === 'standard'}"
                                 @click="report.coverStyle = 'standard'">
                                <div class="preview" style="background-color: #4CAF50; opacity: 0.7;"></div>
                                <div>Standard</div>
                            </div>
                            <div class="pdf-cover-style" 
                                 :class="{selected: report.coverStyle === 'professional'}"
                                 @click="report.coverStyle = 'professional'">
                                <div class="preview" style="background-color: #333; opacity: 0.7;"></div>
                                <div>Professional</div>
                            </div>
                            <div class="pdf-cover-style" 
                                 :class="{selected: report.coverStyle === 'minimal'}"
                                 @click="report.coverStyle = 'minimal'">
                                <div class="preview" style="background-color: #f5f5f5; opacity: 0.7;"></div>
                                <div>Minimal</div>
                            </div>
                            <div class="pdf-cover-style" 
                                 :class="{selected: report.coverStyle === 'custom'}"
                                 @click="report.coverStyle = 'custom'">
                                <div class="preview" style="background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%); opacity: 0.7;"></div>
                                <div>Custom</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pdf-status" :class="{active: pdfStatus.active}">
                    <p v-if="pdfStatus.message">{{ pdfStatus.message }}</p>
                    <p v-if="pdfStatus.error" style="color: var(--error)">{{ pdfStatus.error }}</p>
                    <div class="pdf-progress" v-if="pdfStatus.progress > 0">
                        <div class="pdf-progress-bar" :style="{width: pdfStatus.progress + '%'}"></div>
                    </div>
                </div>

                <h3>Report Preview</h3>
                <div class="report-preview" ref="reportPreview">
                    <div class="report-header">
                        <h2>Ecological & Cultural Site Inspection Report</h2>
                        <p>Prepared for: {{ siteInfo.clientName }} ({{ siteInfo.clientOrg }})</p>
                        <p>Prepared by: {{ report.inspectorName }} ({{ report.inspectorOrg }})</p>
                        <p>Inspection Date: {{ formatDate(siteInfo.inspectionDate) }}</p>
                        <p>Report Date: {{ formatDate(new Date()) }}</p>
                    </div>

                    <div class="report-section">
                        <h3>1. Site Information</h3>
                        <table class="report-table">
                            <tr>
                                <td width="30%">Site Name/Location</td>
                                <td>{{ siteInfo.siteName }}</td>
                            </tr>
                            <tr>
                                <td>Coordinates</td>
                                <td>{{ siteInfo.latitude }}, {{ siteInfo.longitude }}</td>
                            </tr>
                            <tr>
                                <td>Client Name</td>
                                <td>{{ siteInfo.clientName }}</td>
                            </tr>
                            <tr>
                                <td>Client Organization</td>
                                <td>{{ siteInfo.clientOrg }}</td>
                            </tr>
                            <tr>
                                <td>Client Email</td>
                                <td>{{ siteInfo.clientEmail }}</td>
                            </tr>
                            <tr>
                                <td>Client Phone</td>
                                <td>{{ siteInfo.clientPhone }}</td>
                            </tr>
                            <tr>
                                <td>Site Description</td>
                                <td>{{ siteInfo.siteDescription }}</td>
                            </tr>
                        </table>
                        <div v-if="report.includePhotos && siteInfo.photos.length > 0">
                            <h4>Site Photos</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                <img v-for="(photo, index) in siteInfo.photos" :key="index" :src="photo.url" style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid var(--border);">
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>2. Ecological Assessment</h3>
                        <table class="report-table">
                            <tr>
                                <td width="30%">Vegetation Community</td>
                                <td>{{ ecological.vegetationCommunity }}</td>
                            </tr>
                            <tr>
                                <td>Threatened Species</td>
                                <td>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li v-for="(present, species) in ecological.threatenedSpecies" v-if="present">{{ species }}</li>
                                        <li v-if="Object.values(ecological.threatenedSpecies).filter(v => v).length === 0">None observed</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Invasive Species/Weeds</td>
                                <td>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li v-for="(present, weed) in ecological.invasiveSpecies" v-if="present">{{ weed }}</li>
                                        <li v-if="Object.values(ecological.invasiveSpecies).filter(v => v).length === 0">None observed</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Habitat Condition</td>
                                <td>{{ ecological.habitatCondition ? ecological.habitatCondition.charAt(0).toUpperCase() + ecological.habitatCondition.slice(1) : 'Not assessed' }}</td>
                            </tr>
                            <tr>
                                <td>Ecological Notes</td>
                                <td>{{ ecological.notes || 'None' }}</td>
                            </tr>
                        </table>
                        <div v-if="report.includePhotos && ecological.photos.length > 0">
                            <h4>Ecological Photos</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                <img v-for="(photo, index) in ecological.photos" :key="index" :src="photo.url" style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid var(--border);">
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>3. Cultural Heritage Assessment</h3>
                        <table class="report-table">
                            <tr>
                                <td width="30%">Known Cultural Features</td>
                                <td>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li v-for="(present, feature) in cultural.knownFeatures" v-if="present">{{ feature }}</li>
                                        <li v-if="Object.values(cultural.knownFeatures).filter(v => v).length === 0">None observed</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Heritage Register Status</td>
                                <td>{{ formatHeritageStatus(cultural.heritageRegister) }}</td>
                            </tr>
                            <tr>
                                <td>Consultation with Traditional Owners</td>
                                <td>{{ formatConsultationStatus(cultural.consultation) }}</td>
                            </tr>
                            <tr>
                                <td>Cultural Significance</td>
                                <td>{{ cultural.significance || 'Not assessed' }}</td>
                            </tr>
                            <tr>
                                <td>Cultural Notes</td>
                                <td>{{ cultural.notes || 'None' }}</td>
                            </tr>
                        </table>
                        <div v-if="report.includePhotos && cultural.photos.length > 0">
                            <h4>Cultural Heritage Photos</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                <img v-for="(photo, index) in cultural.photos" :key="index" :src="photo.url" style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid var(--border);">
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>4. Risk Assessment</h3>
                        <table class="report-table">
                            <tr>
                                <td width="30%">Soil Condition</td>
                                <td>{{ riskAssessment.soilCondition ? riskAssessment.soilCondition.charAt(0).toUpperCase() + riskAssessment.soilCondition.slice(1) : 'Not assessed' }}</td>
                            </tr>
                            <tr>
                                <td>Erosion Risk</td>
                                <td>{{ riskAssessment.erosionRisk ? riskAssessment.erosionRisk.charAt(0).toUpperCase() + riskAssessment.erosionRisk.slice(1) : 'Not assessed' }}</td>
                            </tr>
                            <tr>
                                <td>Disturbance Level</td>
                                <td>{{ riskAssessment.disturbanceLevel ? riskAssessment.disturbanceLevel.charAt(0).toUpperCase() + riskAssessment.disturbanceLevel.slice(1) : 'Not assessed' }}</td>
                            </tr>
                            <tr>
                                <td>Hazards Present</td>
                                <td>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li v-for="(present, hazard) in riskAssessment.hazards" v-if="present">{{ hazard }}</li>
                                        <li v-if="Object.values(riskAssessment.hazards).filter(v => v).length === 0">None observed</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Overall Risk Level</td>
                                <td>{{ riskAssessment.riskLevel ? riskAssessment.riskLevel.charAt(0).toUpperCase() + riskAssessment.riskLevel.slice(1) : 'Not assessed' }}</td>
                            </tr>
                            <tr>
                                <td>Risk Notes</td>
                                <td>{{ riskAssessment.notes || 'None' }}</td>
                            </tr>
                        </table>
                        <div v-if="report.includePhotos && riskAssessment.photos.length > 0">
                            <h4>Risk Photos</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                <img v-for="(photo, index) in riskAssessment.photos" :key="index" :src="photo.url" style="max-width: 200px; max-height: 150px; object-fit: contain; border: 1px solid var(--border);">
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>5. Recommended Mitigation Actions</h3>
                        <h4>Ecological Mitigation</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li v-for="(selected, measure) in mitigation.ecologicalMeasures" v-if="selected">{{ measure }}</li>
                            <li v-if="Object.values(mitigation.ecologicalMeasures).filter(v => v).length === 0">None recommended</li>
                        </ul>
                        <p v-if="mitigation.ecologicalDetails" style="margin-top: 10px;">{{ mitigation.ecologicalDetails }}</p>

                        <h4>Cultural Heritage Mitigation</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li v-for="(selected, measure) in mitigation.culturalMeasures" v-if="selected">{{ measure }}</li>
                            <li v-if="Object.values(mitigation.culturalMeasures).filter(v => v).length === 0">None recommended</li>
                        </ul>
                        <p v-if="mitigation.culturalDetails" style="margin-top: 10px;">{{ mitigation.culturalDetails }}</p>

                        <h4>General Site Mitigation</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li v-for="(selected, measure) in mitigation.generalMeasures" v-if="selected">{{ measure }}</li>
                            <li v-if="Object.values(mitigation.generalMeasures).filter(v => v).length === 0">None recommended</li>
                        </ul>
                        <p v-if="mitigation.generalDetails" style="margin-top: 10px;">{{ mitigation.generalDetails }}</p>

                        <h4>Monitoring Requirements</h4>
                        <p>{{ mitigation.monitoring || 'None specified' }}</p>
                    </div>

                    <div class="report-section">
                        <h3>6. Inspector Details</h3>
                        <table class="report-table">
                            <tr>
                                <td width="30%">Inspector Name</td>
                                <td>{{ report.inspectorName }}</td>
                            </tr>
                            <tr>
                                <td>Organization</td>
                                <td>{{ report.inspectorOrg }}</td>
                            </tr>
                            <tr>
                                <td>Qualifications</td>
                                <td>{{ report.inspectorQualifications }}</td>
                            </tr>
                            <tr>
                                <td>Signature</td>
                                <td><img v-if="report.signatureData" :src="report.signatureData" width="200"></td>
                            </tr>
                        </table>
                        <div v-if="report.notes">
                            <h4>Additional Report Notes</h4>
                            <p>{{ report.notes }}</p>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" @click="prevTab">Back to Mitigation</button>
                    <button class="btn btn-secondary" @click="saveInspection">Save Progress</button>
                    <button class="btn btn-primary" @click="generatePDF">Generate PDF Report</button>
                </div>
            </div>

            <!-- Resources Tab (Bonus) -->
            <div class="tab-content" :class="{active: activeTab === 6}">
                <h2>Resources & Learning</h2>
                
                <div v-if="learnerMode">
                    <h3>Quick Quiz</h3>
                    <div class="quiz-question">
                        <p>1. What is the first step in conducting an ecological site inspection?</p>
                        <div class="quiz-options">
                            <div class="quiz-option">
                                <input type="radio" name="q1" id="q1a" value="a" v-model="quizAnswers.q1">
                                <label for="q1a">Identify all plant species present</label>
                            </div>
                            <div class="quiz-option">
                                <input type="radio" name="q1" id="q1b" value="b" v-model="quizAnswers.q1">
                                <label for="q1b">Assess the site context and access information</label>
                            </div>
                            <div class="quiz-option">
                                <input type="radio" name="q1" id="q1c" value="c" v-model="quizAnswers.q1">
                                <label for="q1c">Document any cultural heritage features</label>
                            </div>
                        </div>
                        <div class="quiz-feedback" :class="{correct: quizAnswers.q1 === 'b', incorrect: quizAnswers.q1 && quizAnswers.q1 !== 'b'}" v-if="quizAnswers.q1">
                            <span v-if="quizAnswers.q1 === 'b'">✓ Correct! Understanding the site context is the essential first step.</span>
                            <span v-else>✗ Incorrect. The first step should always be to assess the site context and access information.</span>
                        </div>
                    </div>

                    <div class="quiz-question">
                        <p>2. When assessing cultural heritage, what should you do if you find an artifact?</p>
                        <div class="quiz-options">
                            <div class="quiz-option">
                                <input type="radio" name="q2" id="q2a" value="a" v-model="quizAnswers.q2">
                                <label for="q2a">Collect it for further analysis</label>
                            </div>
                            <div class="quiz-option">
                                <input type="radio" name="q2" id="q2b" value="b" v-model="quizAnswers.q2">
                                <label for="q2b">Leave it in place and note its location</label>
                            </div>
                            <div class="quiz-option">
                                <input type="radio" name="q2" id="q2c" value="c" v-model="quizAnswers.q2">
                                <label for="q2c">Take a photo but don't record the location</label>
                            </div>
                        </div>
                        <div class="quiz-feedback" :class="{correct: quizAnswers.q2 === 'b', incorrect: quizAnswers.q2 && quizAnswers.q2 !== 'b'}" v-if="quizAnswers.q2">
                            <span v-if="quizAnswers.q2 === 'b'">✓ Correct! Artifacts should be left in place and their location carefully documented.</span>
                            <span v-else>✗ Incorrect. Artifacts should never be collected without proper authorization and should always have their location recorded.</span>
                        </div>
                    </div>
                </div>

                <h3>Reference Materials</h3>
                <div class="resources-grid">
                    <div class="resource-card">
                        <h4>Vegetation Communities Guide</h4>
                        <p>Common vegetation communities and their characteristics in your region.</p>
                        <button class="btn btn-secondary" style="width: 100%;">Download Guide</button>
                    </div>
                    <div class="resource-card">
                        <h4>Threatened Species Checklist</h4>
                        <p>List of threatened flora and fauna species with identification tips.</p>
                        <button class="btn btn-secondary" style="width: 100%;">Download Checklist</button>
                    </div>
                    <div class="resource-card">
                        <h4>Cultural Heritage Protocols</h4>
                        <p>Guidelines for identifying and protecting cultural heritage features.</p>
                        <button class="btn btn-secondary" style="width: 100%;">Download Protocols</button>
                    </div>
                    <div class="resource-card">
                        <h4>Risk Assessment Matrix</h4>
                        <p>Detailed explanation of the risk assessment process and matrix.</p>
                        <button class="btn btn-secondary" style="width: 100%;">Download Matrix</button>
                    </div>
                </div>

                <h3>Common Species Gallery</h3>
                <div class="photo-preview">
                    <img src="https://via.placeholder.com/100?text=Species+1" class="photo-thumbnail">
                    <img src="https://via.placeholder.com/100?text=Species+2" class="photo-thumbnail">
                    <img src="https://via.placeholder.com/100?text=Species+3" class="photo-thumbnail">
                    <img src="https://via.placeholder.com/100?text=Species+4" class="photo-thumbnail">
                    <img src="https://via.placeholder.com/100?text=Species+5" class="photo-thumbnail">
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" @click="prevTab">Back to Report</button>
                    <button class="btn btn-primary" @click="finishInspection">Finish Inspection</button>
                </div>
            </div>
        </div>

        <!-- Photo Modal -->
        <div class="modal" v-if="photoModal.show" @click.self="photoModal.show = false" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div style="background: var(--bg); padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%;">
                <img :src="photoModal.src" style="max-width: 100%; max-height: 80vh;">
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" @click="photoModal.show = false">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        
        createApp({
            setup() {
                // Theme management
                const darkMode = ref(false);
                
                const toggleTheme = () => {
                    darkMode.value = !darkMode.value;
                    document.documentElement.setAttribute('data-theme', darkMode.value ? 'dark' : 'light');
                    localStorage.setItem('darkMode', darkMode.value);
                };
                
                // Check for saved theme preference
                onMounted(() => {
                    const savedMode = localStorage.getItem('darkMode') === 'true';
                    darkMode.value = savedMode;
                    document.documentElement.setAttribute('data-theme', darkMode.value ? 'dark' : 'light');
                });
                
                // Learner mode toggle
                const learnerMode = ref(true);
                
                // Tab management
                const tabs = ref([
                    { name: 'Site Info', complete: false },
                    { name: 'Ecological', complete: false },
                    { name: 'Cultural', complete: false },
                    { name: 'Risk', complete: false },
                    { name: 'Mitigation', complete: false },
                    { name: 'Report', complete: false },
                    { name: 'Resources', complete: false }
                ]);
                
                const activeTab = ref(0);
                
                const prevTab = () => {
                    if (activeTab.value > 0) activeTab.value--;
                };
                
                const nextTab = () => {
                    // Mark current tab as complete
                    tabs.value[activeTab.value].complete = true;
                    
                    if (activeTab.value < tabs.value.length - 1) activeTab.value++;
                };
                
                // Calculate progress
                const progress = computed(() => {
                    const completeCount = tabs.value.filter(tab => tab.complete).length;
                    return (completeCount / tabs.value.length) * 100;
                });
                
                // Coordinate validation
                const coordErrors = ref({
                    latitude: false,
                    longitude: false,
                    map: false
                });
                
                const validateCoordinates = () => {
                    const lat = parseFloat(siteInfo.value.latitude);
                    const lng = parseFloat(siteInfo.value.longitude);
                    
                    coordErrors.value.latitude = isNaN(lat) || lat < -90 || lat > 90;
                    coordErrors.value.longitude = isNaN(lng) || lng < -180 || lng > 180;
                    
                    return !coordErrors.value.latitude && !coordErrors.value.longitude;
                };
                
                const validateAndNextTab = () => {
                    if (!validateCoordinates()) {
                        alert('Please enter valid coordinates before proceeding');
                        return;
                    }
                    
                    if (!siteInfo.value.siteName) {
                        alert('Please enter a site name before proceeding');
                        return;
                    }
                    
                    nextTab();
                };
                
                // Data models
                const siteInfo = ref({
                    inspectionDate: new Date().toISOString().split('T')[0],
                    siteName: '',
                    latitude: '',
                    longitude: '',
                    mapSelected: false,
                    clientName: '',
                    clientOrg: '',
                    clientEmail: '',
                    clientPhone: '',
                    siteDescription: '',
                    photos: []
                });
                
                // Initialize map
                const mainMap = ref(null);
                const mapMarker = ref(null);
                
                onMounted(() => {
                    // Initialize main map (centered on Australia by default)
                    mainMap.value = L.map('main-map').setView([-25.2744, 133.7751], 4);
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(mainMap.value);
                    
                    // Add click handler for placing marker
                    mainMap.value.on('click', (e) => {
                        placeMarker(e.latlng);
                    });
                });
                
                const placeMarker = (latlng) => {
                    if (!mapMarker.value) {
                        mapMarker.value = L.marker(latlng).addTo(mainMap.value);
                    } else {
                        mapMarker.value.setLatLng(latlng);
                    }
                    
                    // Update coordinates in form
                    siteInfo.value.latitude = latlng.lat.toFixed(6);
                    siteInfo.value.longitude = latlng.lng.toFixed(6);
                    siteInfo.value.mapSelected = true;
                    coordErrors.value.map = false;
                };
                
                const locateUser = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const userLatLng = [position.coords.latitude, position.coords.longitude];
                                mainMap.value.setView(userLatLng, 15);
                                placeMarker(userLatLng);
                            },
                            (error) => {
                                alert(`Error getting location: ${error.message}`);
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        alert("Geolocation is not supported by this browser.");
                    }
                };
                
                // Watch for coordinate changes and update map
                watch(() => [siteInfo.value.latitude, siteInfo.value.longitude], ([lat, lng]) => {
                    if (lat && lng && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
                        const newLatLng = [parseFloat(lat), parseFloat(lng)];
                        if (mainMap.value && mapMarker.value) {
                            mapMarker.value.setLatLng(newLatLng);
                            mainMap.value.setView(newLatLng, mainMap.value.getZoom());
                        }
                    }
                });
                
                const vegetationCommunities = ref([
                    'Dry Sclerophyll Forest',
                    'Wet Sclerophyll Forest',
                    'Rainforest',
                    'Grassland',
                    'Heathland',
                    'Mangrove',
                    'Saltmarsh',
                    'Riparian Zone',
                    'Agricultural Land',
                    'Urban/Developed Area'
                ]);
                
                const threatenedSpecies = ref([
                    'Koala (Phascolarctos cinereus)',
                    'Regent Honeyeater (Anthochaera phrygia)',
                    'Swift Parrot (Lathamus discolor)',
                    'Giant Burrowing Frog (Heleioporus australiacus)',
                    'Eastern Bristlebird (Dasyornis brachypterus)'
                ]);
                
                const invasiveSpecies = ref([
                    'Lantana (Lantana camara)',
                    'Bitou Bush (Chrysanthemoides monilifera)',
                    'African Olive (Olea europaea subsp. cuspidata)',
                    'Blackberry (Rubus fruticosus agg.)',
                    'Scotch Broom (Cytisus scoparius)'
                ]);
                
                const ecological = ref({
                    vegetationCommunity: '',
                    threatenedSpecies: {},
                    invasiveSpecies: {},
                    habitatCondition: '',
                    notes: '',
                    photos: []
                });
                
                // Initialize checkboxes
                onMounted(() => {
                    threatenedSpecies.value.forEach(species => {
                        ecological.value.threatenedSpecies[species] = false;
                    });
                    
                    invasiveSpecies.value.forEach(weed => {
                        ecological.value.invasiveSpecies[weed] = false;
                    });
                });
                
                const addThreatenedSpecies = () => {
                    const species = prompt('Enter the name of the threatened species:');
                    if (species) {
                        threatenedSpecies.value.push(species);
                        ecological.value.threatenedSpecies[species] = true;
                    }
                };
                
                const addInvasiveSpecies = () => {
                    const weed = prompt('Enter the name of the invasive species/weed:');
                    if (weed) {
                        invasiveSpecies.value.push(weed);
                        ecological.value.invasiveSpecies[weed] = true;
                    }
                };
                
                const culturalFeatures = ref([
                    'Aboriginal Artefacts',
                    'Scarred Trees',
                    'Middens',
                    'Rock Engravings',
                    'Rock Paintings',
                    'Burial Sites',
                    'Ceremonial Sites',
                    'Historic Structures',
                    'Historic Land Use Features',
                    'Cultural Landscapes'
                ]);
                
                const getFeatureDescription = (feature) => {
                    const descriptions = {
                        'Aboriginal Artefacts': 'Stone tools, grinding stones, or other objects made or modified by Aboriginal people',
                        'Scarred Trees': 'Trees with bark or wood removed by Aboriginal people for making canoes, shields, or other items',
                        'Middens': 'Accumulations of shells, bones, and other food remains indicating past Aboriginal occupation',
                        'Rock Engravings': 'Images or designs carved into rock surfaces',
                        'Rock Paintings': 'Painted designs or images on rock surfaces, often using ochre',
                        'Burial Sites': 'Locations where human remains are interred',
                        'Ceremonial Sites': 'Places used for rituals, ceremonies, or gatherings',
                        'Historic Structures': 'Buildings, fences, or other structures from the post-contact period',
                        'Historic Land Use Features': 'Evidence of past land use like old roads, mines, or agricultural features',
                        'Cultural Landscapes': 'Areas with cultural significance that may include multiple features or natural elements'
                    };
                    return descriptions[feature] || 'No description available';
                };
                
                const cultural = ref({
                    knownFeatures: {},
                    significance: '',
                    heritageRegister: '',
                    consultation: '',
                    notes: '',
                    photos: []
                });
                
                // Initialize checkboxes
                onMounted(() => {
                    culturalFeatures.value.forEach(feature => {
                        cultural.value.knownFeatures[feature] = false;
                    });
                });
                
                const addCulturalFeature = () => {
                    const feature = prompt('Enter the name of the cultural feature:');
                    if (feature) {
                        culturalFeatures.value.push(feature);
                        cultural.value.knownFeatures[feature] = true;
                    }
                };
                
                const hazards = ref([
                    'Unstable Ground',
                    'Steep Slopes',
                    'Water Bodies',
                    'Overhead Power Lines',
                    'Underground Services',
                    'Toxic Plants',
                    'Wildlife Hazards',
                    'Extreme Weather Risk',
                    'Remote Location',
                    'Poor Access'
                ]);
                
                const riskAssessment = ref({
                    soilCondition: '',
                    erosionRisk: '',
                    disturbanceLevel: '',
                    hazards: {},
                    riskLevel: '',
                    notes: '',
                    photos: []
                });
                
                // Initialize checkboxes
                onMounted(() => {
                    hazards.value.forEach(hazard => {
                        riskAssessment.value.hazards[hazard] = false;
                    });
                });
                
                const addHazard = () => {
                    const hazard = prompt('Enter the name of the hazard:');
                    if (hazard) {
                        hazards.value.push(hazard);
                        riskAssessment.value.hazards[hazard] = true;
                    }
                };
                
                const riskMatrix = ref([
                    [
                        { label: 'Low', value: 'low', class: 'risk-low' },
                        { label: 'Low', value: 'low', class: 'risk-low' },
                        { label: 'Medium', value: 'medium', class: 'risk-medium' },
                        { label: 'Medium', value: 'medium', class: 'risk-medium' },
                        { label: 'High', value: 'high', class: 'risk-high' }
                    ],
                    [
                        { label: 'Low', value: 'low', class: 'risk-low' },
                        { label: 'Medium', value: 'medium', class: 'risk-medium' },
                        { label: 'Medium', value: 'medium', class: 'risk-medium' },
                        { label: 'High', value: 'high', class: 'risk-high' },
                        { label: 'High', value: 'high', class: 'risk-high' }
                    ],
                    [
                        { label: 'Medium', value: 'medium', class: 'risk-medium' },
                        { label: 'Medium', value: 'medium', class: 'risk-medium' },
                        { label: 'High', value: 'high', class: 'risk-high' },
                        { label: 'High', value: 'high', class: 'risk-high' },
                        { label: 'Extreme', value: 'extreme', class: 'risk-extreme' }
                    ],
                    [
                        { label: 'Medium', value: 'medium', class: 'risk-medium' },
                        { label: 'High', value: 'high', class: 'risk-high' },
                        { label: 'High', value: 'high', class: 'risk-high' },
                        { label: 'Extreme', value: 'extreme', class: 'risk-extreme' },
                        { label: 'Extreme', value: 'extreme', class: 'risk-extreme' }
                    ],
                    [
                        { label: 'High', value: 'high', class: 'risk-high' },
                        { label: 'High', value: 'high', class: 'risk-high' },
                        { label: 'Extreme', value: 'extreme', class: 'risk-extreme' },
                        { label: 'Extreme', value: 'extreme', class: 'risk-extreme' },
                        { label: 'Extreme', value: 'extreme', class: 'risk-extreme' }
                    ]
                ]);
                
                const ecologicalMitigation = ref([
                    'Pre-works surveys for threatened species',
                    'Timing restrictions for sensitive periods',
                    'Habitat retention areas',
                    'Nest box installation',
                    'Weed management prior to works',
                    'Erosion and sediment controls',
                    'Noise and vibration mitigation',
                    'Light pollution reduction',
                    'Revegetation plan',
                    'Monitoring program'
                ]);
                
                const culturalMitigation = ref([
                    'Cultural heritage survey',
                    'Buffer zones around sensitive areas',
                    'Aboriginal monitor on site',
                    'Archaeological test excavation',
                    'Avoidance of sensitive areas',
                    'Salvage of artifacts if disturbance unavoidable',
                    'Recording of heritage features',
                    'Community consultation',
                    'Protective fencing',
                    'Interpretive signage'
                ]);
                
                const generalMitigation = ref([
                    'Erosion and sediment controls',
                    'Dust suppression measures',
                    'Noise reduction strategies',
                    'Traffic management plan',
                    'Waste management plan',
                    'Spill response plan',
                    'Emergency procedures',
                    'Site induction for workers',
                    'Regular site inspections',
                    'Rehabilitation plan'
                ]);
                
                const mitigation = ref({
                    ecologicalMeasures: {},
                    ecologicalDetails: '',
                    culturalMeasures: {},
                    culturalDetails: '',
                    generalMeasures: {},
                    generalDetails: '',
                    monitoring: ''
                });
                
                // Initialize checkboxes
                onMounted(() => {
                    ecologicalMitigation.value.forEach(measure => {
                        mitigation.value.ecologicalMeasures[measure] = false;
                    });
                    
                    culturalMitigation.value.forEach(measure => {
                        mitigation.value.culturalMeasures[measure] = false;
                    });
                    
                    generalMitigation.value.forEach(measure => {
                        mitigation.value.generalMeasures[measure] = false;
                    });
                });
                
                const addEcologicalMitigation = () => {
                    const measure = prompt('Enter the ecological mitigation measure:');
                    if (measure) {
                        ecologicalMitigation.value.push(measure);
                        mitigation.value.ecologicalMeasures[measure] = true;
                    }
                };
                
                const addCulturalMitigation = () => {
                    const measure = prompt('Enter the cultural heritage mitigation measure:');
                    if (measure) {
                        culturalMitigation.value.push(measure);
                        mitigation.value.culturalMeasures[measure] = true;
                    }
                };
                
                const addGeneralMitigation = () => {
                    const measure = prompt('Enter the general site mitigation measure:');
                    if (measure) {
                        generalMitigation.value.push(measure);
                        mitigation.value.generalMeasures[measure] = true;
                    }
                };
                
                const report = ref({
                    inspectorName: '',
                    inspectorOrg: '',
                    inspectorQualifications: '',
                    signatureData: '',
                    notes: '',
                    includePhotos: true,
                    includeDetails: true,
                    excludeEmpty: true,
                    imageQuality: 'medium',
                    coverStyle: 'standard',
                    tableOfContents: true,
                    headerFooter: true,
                    pageNumbers: true
                });
                
                // PDF Generation Status
                const pdfStatus = ref({
                    active: false,
                    message: '',
                    error: '',
                    progress: 0
                });
                
                // Photo handling
                const photoModal = ref({
                    show: false,
                    src: ''
                });
                
                const viewPhoto = (photo) => {
                    photoModal.value.src = photo.url;
                    photoModal.value.show = true;
                };
                
                const triggerPhotoUpload = (section) => {
                    document.getElementById(`${section}-photo-upload`).click();
                };
                
                const removePhoto = (section, index) => {
                    if (confirm('Are you sure you want to remove this photo?')) {
                        switch (section) {
                            case 'site':
                                siteInfo.value.photos.splice(index, 1);
                                break;
                            case 'eco':
                                ecological.value.photos.splice(index, 1);
                                break;
                            case 'cultural':
                                cultural.value.photos.splice(index, 1);
                                break;
                            case 'risk':
                                riskAssessment.value.photos.splice(index, 1);
                                break;
                        }
                    }
                };
                
                const compressAndAddPhoto = async (file, targetArray) => {
                    try {
                        const options = {
                            maxSizeMB: 1,
                            maxWidthOrHeight: 1920,
                            useWebWorker: true
                        };
                        const compressedFile = await imageCompression(file, options);
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            targetArray.push({
                                name: file.name,
                                url: e.target.result,
                                date: new Date().toISOString(),
                                originalFile: file
                            });
                        };
                        reader.readAsDataURL(compressedFile);
                    } catch (error) {
                        console.error('Error compressing image:', error);
                        // Fallback to original if compression fails
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            targetArray.push({
                                name: file.name,
                                url: e.target.result,
                                date: new Date().toISOString(),
                                originalFile: file
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                const handlePhotoUpload = (e, section) => {
                    const files = e.target.files;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        switch (section) {
                            case 'site':
                                compressAndAddPhoto(file, siteInfo.value.photos);
                                break;
                            case 'eco':
                                compressAndAddPhoto(file, ecological.value.photos);
                                break;
                            case 'cultural':
                                compressAndAddPhoto(file, cultural.value.photos);
                                break;
                            case 'risk':
                                compressAndAddPhoto(file, riskAssessment.value.photos);
                                break;
                        }
                    }
                    e.target.value = ''; // Reset input to allow selecting same file again
                };
                
                // Signature handling
                const signaturePad = ref(null);
                let signatureCanvas = null;
                let signatureCtx = null;
                let isDrawing = false;
                
                onMounted(() => {
                    nextTick(() => {
                        if (signaturePad.value) {
                            signatureCanvas = signaturePad.value.querySelector('canvas');
                            signatureCtx = signatureCanvas.getContext('2d');
                            
                            // Set up signature pad
                            signatureCanvas.addEventListener('mousedown', startDrawing);
                            signatureCanvas.addEventListener('mousemove', draw);
                            signatureCanvas.addEventListener('mouseup', stopDrawing);
                            signatureCanvas.addEventListener('mouseout', stopDrawing);
                            
                            // Touch support for mobile devices
                            signatureCanvas.addEventListener('touchstart', startDrawing);
                            signatureCanvas.addEventListener('touchmove', draw);
                            signatureCanvas.addEventListener('touchend', stopDrawing);
                        }
                    });
                });
                
                const startDrawing = (e) => {
                    isDrawing = true;
                    draw(e);
                };
                
                const draw = (e) => {
                    if (!isDrawing) return;
                    
                    e.preventDefault();
                    
                    const rect = signatureCanvas.getBoundingClientRect();
                    let clientX, clientY;
                    
                    if (e.type === 'mousemove') {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    } else if (e.type === 'touchmove') {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    }
                    
                    const x = clientX - rect.left;
                    const y = clientY - rect.top;
                    
                    signatureCtx.lineWidth = 2;
                    signatureCtx.lineCap = 'round';
                    signatureCtx.strokeStyle = darkMode.value ? '#FFFFFF' : '#000000';
                    
                    signatureCtx.lineTo(x, y);
                    signatureCtx.stroke();
                    signatureCtx.beginPath();
                    signatureCtx.moveTo(x, y);
                };
                
                const stopDrawing = () => {
                    isDrawing = false;
                    signatureCtx.beginPath();
                    
                    // Save signature data
                    report.value.signatureData = signatureCanvas.toDataURL();
                };
                
                const clearSignature = () => {
                    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                    report.value.signatureData = '';
                };
                
                // Quiz handling
                const quizAnswers = ref({
                    q1: '',
                    q2: ''
                });
                
                // Save and load inspection data
                const saveInspection = () => {
                    const inspectionData = {
                        siteInfo: siteInfo.value,
                        ecological: ecological.value,
                        cultural: cultural.value,
                        riskAssessment: riskAssessment.value,
                        mitigation: mitigation.value,
                        report: report.value,
                        tabs: tabs.value,
                        activeTab: activeTab.value
                    };
                    
                    localStorage.setItem('currentInspection', JSON.stringify(inspectionData));
                    alert('Inspection progress saved successfully!');
                };
                
                const loadInspection = () => {
                    const savedData = localStorage.getItem('currentInspection');
                    if (savedData) {
                        const inspectionData = JSON.parse(savedData);
                        
                        siteInfo.value = inspectionData.siteInfo;
                        ecological.value = inspectionData.ecological;
                        cultural.value = inspectionData.cultural;
                        riskAssessment.value = inspectionData.riskAssessment;
                        mitigation.value = inspectionData.mitigation;
                        report.value = inspectionData.report;
                        tabs.value = inspectionData.tabs;
                        activeTab.value = inspectionData.activeTab;
                        
                        // Re-initialize any empty objects that might have been lost in serialization
                        if (!ecological.value.threatenedSpecies) ecological.value.threatenedSpecies = {};
                        if (!ecological.value.invasiveSpecies) ecological.value.invasiveSpecies = {};
                        if (!cultural.value.knownFeatures) cultural.value.knownFeatures = {};
                        if (!riskAssessment.value.hazards) riskAssessment.value.hazards = {};
                        if (!mitigation.value.ecologicalMeasures) mitigation.value.ecologicalMeasures = {};
                        if (!mitigation.value.culturalMeasures) mitigation.value.culturalMeasures = {};
                        if (!mitigation.value.generalMeasures) mitigation.value.generalMeasures = {};
                        
                        // Update map marker if coordinates exist
                        if (siteInfo.value.latitude && siteInfo.value.longitude) {
                            const lat = parseFloat(siteInfo.value.latitude);
                            const lng = parseFloat(siteInfo.value.longitude);
                            if (!isNaN(lat) && !isNaN(lng)) {
                                placeMarker([lat, lng]);
                                mainMap.value.setView([lat, lng], 15);
                            }
                        }
                        
                        alert('Inspection progress loaded successfully!');
                    } else {
                        alert('No saved inspection found.');
                    }
                };
                
                // Load any saved inspection on startup
                onMounted(() => {
                    const shouldLoad = confirm('Would you like to load your last saved inspection?');
                    if (shouldLoad) {
                        loadInspection();
                    }
                });
                
                // Report generation
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-AU', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };
                
                const formatHeritageStatus = (status) => {
                    if (!status) return 'Not assessed';
                    const statusMap = {
                        'listed': 'Listed on heritage register',
                        'potential': 'Potential heritage significance',
                        'none': 'No known heritage listing',
                        'unknown': 'Not checked'
                    };
                    return statusMap[status] || status;
                };
                
                const formatConsultationStatus = (status) => {
                    if (!status) return 'Not assessed';
                    const statusMap = {
                        'completed': 'Consultation completed',
                        'pending': 'Consultation pending',
                        'required': 'Consultation required',
                        'not-applicable': 'Not applicable'
                    };
                    return statusMap[status] || status;
                };
                
                // Helper function to check if a section has data
                const sectionHasData = (sectionData) => {
                    if (typeof sectionData === 'object' && sectionData !== null) {
                        return Object.values(sectionData).some(value => {
                            if (typeof value === 'object' && value !== null) {
                                return Object.values(value).some(v => v);
                            }
                            return !!value;
                        });
                    }
                    return !!sectionData;
                };
                
                // Main PDF generation function
                const generatePDF = async () => {
                    try {
                        // Initialize PDF status
                        pdfStatus.value = {
                            active: true,
                            message: 'Preparing report...',
                            error: '',
                            progress: 0
                        };
                        
                        // Get the jsPDF library
                        const { jsPDF } = window.jspdf;
                        
                        // Create a new PDF document
                        const doc = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });
                        
                        // Set document properties
                        doc.setProperties({
                            title: `Site Inspection Report - ${siteInfo.value.siteName || 'Unnamed Site'}`,
                            subject: 'Ecological and Cultural Site Inspection',
                            author: report.value.inspectorName || 'Unknown Inspector',
                            keywords: 'ecological, cultural, heritage, inspection, report',
                            creator: 'Ecological & Cultural Site Inspector'
                        });
                        
                        // Update progress
                        pdfStatus.value.progress = 5;
                        pdfStatus.value.message = 'Creating cover page...';
                        
                        // Add cover page based on selected style
                        doc.addPage();
                        
                        // Cover page styling based on selected style
                        let coverBgColor, coverTextColor, coverTitleSize, coverSubtitleSize;
                        
                        switch (report.value.coverStyle) {
                            case 'professional':
                                coverBgColor = '#333333';
                                coverTextColor = '#FFFFFF';
                                coverTitleSize = 24;
                                coverSubtitleSize = 14;
                                break;
                            case 'minimal':
                                coverBgColor = '#F5F5F5';
                                coverTextColor = '#333333';
                                coverTitleSize = 20;
                                coverSubtitleSize = 12;
                                break;
                            case 'custom':
                                coverBgColor = 'linear-gradient(135deg, #4CAF50 0%, #2196F3 100%)';
                                coverTextColor = '#FFFFFF';
                                coverTitleSize = 22;
                                coverSubtitleSize = 13;
                                break;
                            default: // standard
                                coverBgColor = '#4CAF50';
                                coverTextColor = '#FFFFFF';
                                coverTitleSize = 22;
                                coverSubtitleSize = 13;
                        }
                        
                        // Add cover background
                        if (coverBgColor.startsWith('linear-gradient')) {
                            // For custom gradient background
                            const gradient = doc.createLinearGradient(0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight());
                            gradient.addColorStop(0, '#4CAF50');
                            gradient.addColorStop(1, '#2196F3');
                            doc.setFillColor(gradient);
                        } else {
                            doc.setFillColor(coverBgColor);
                        }
                        doc.rect(0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight(), 'F');
                        
                        // Add cover content
                        doc.setTextColor(coverTextColor);
                        doc.setFontSize(coverTitleSize);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Ecological & Cultural', 105, 80, { align: 'center' });
                        doc.text('Site Inspection Report', 105, 90, { align: 'center' });
                        
                        doc.setFontSize(coverSubtitleSize);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Site: ${siteInfo.value.siteName || 'Not specified'}`, 105, 110, { align: 'center' });
                        doc.text(`Prepared for: ${siteInfo.value.clientName || 'Not specified'}`, 105, 120, { align: 'center' });
                        doc.text(`Prepared by: ${report.value.inspectorName || 'Not specified'}`, 105, 130, { align: 'center' });
                        doc.text(`Date: ${formatDate(new Date())}`, 105, 140, { align: 'center' });
                        
                        // Add logo or decorative element
                        doc.setFontSize(10);
                        doc.text('Ecological & Cultural Site Inspector', 105, 180, { align: 'center' });
                        
                        // Add page for table of contents if enabled
                        if (report.value.tableOfContents) {
                            doc.addPage();
                            pdfStatus.value.progress = 10;
                            pdfStatus.value.message = 'Creating table of contents...';
                            
                            doc.setTextColor('#000000');
                            doc.setFontSize(16);
                            doc.text('Table of Contents', 20, 20);
                            
                            doc.setFontSize(12);
                            let tocY = 30;
                            const sections = [
                                '1. Site Information',
                                '2. Ecological Assessment',
                                '3. Cultural Heritage Assessment',
                                '4. Risk Assessment',
                                '5. Recommended Mitigation Actions',
                                '6. Inspector Details'
                            ];
                            
                            sections.forEach(section => {
                                doc.text(section, 20, tocY);
                                // Add dotted line and page number (will be filled later)
                                doc.text('............................', 60, tocY);
                                tocY += 7;
                            });
                        }
                        
                        // Start adding content pages
                        let currentPage = report.value.tableOfContents ? 3 : 2; // After cover and possibly TOC
                        
                        // Function to add a new page with header if enabled
                        const addContentPage = (title) => {
                            if (currentPage > (report.value.tableOfContents ? 3 : 2)) {
                                doc.addPage();
                            }
                            
                            // Add header if enabled
                            if (report.value.headerFooter) {
                                doc.setFontSize(10);
                                doc.setTextColor('#666666');
                                doc.text(`Ecological & Cultural Site Inspection - ${siteInfo.value.siteName || 'Unnamed Site'}`, 20, 10);
                                if (report.value.pageNumbers) {
                                    doc.text(`Page ${currentPage}`, 180, 10, { align: 'right' });
                                }
                                
                                // Add section title
                                doc.setFontSize(16);
                                doc.setTextColor('#000000');
                                doc.text(title, 20, 20);
                            } else {
                                // Just add section title without header
                                doc.setFontSize(16);
                                doc.setTextColor('#000000');
                                doc.text(title, 20, 20);
                            }
                            
                            currentPage++;
                            return report.value.headerFooter ? 25 : 20; // Return starting Y position for content
                        };
                        
                        // Function to add a table to the PDF
                        const addTableToPDF = (headers, data, startY) => {
                            const tableData = data.map(row => headers.map(header => row[header] || ''));
                            
                            doc.autoTable({
                                head: [headers],
                                body: tableData,
                                startY: startY,
                                margin: { left: 20, right: 20 },
                                styles: {
                                    fontSize: 10,
                                    cellPadding: 4,
                                    overflow: 'linebreak',
                                    valign: 'middle'
                                },
                                headStyles: {
                                    fillColor: [76, 175, 80],
                                    textColor: 255,
                                    fontStyle: 'bold'
                                },
                                alternateRowStyles: {
                                    fillColor: [245, 245, 245]
                                },
                                didDrawPage: (data) => {
                                    // Check if we need to add a new page
                                    if (data.cursor.y > doc.internal.pageSize.height - 20) {
                                        const newY = addContentPage('');
                                        data.cursor.y = newY;
                                    }
                                }
                            });
                            
                            return doc.autoTable.previous.finalY + 10;
                        };
                        
                // Function to add an image to the PDF with proper scaling and positioning
                const addImageToPDF = async (imgData, startY, maxWidth = 170, maxHeight = 100) => {
                    try {
                        // Compress image based on selected quality
                        let quality;
                        switch (report.value.imageQuality) {
                            case 'low': quality = 0.5; break;
                            case 'high': quality = 0.9; break;
                            default: quality = 0.7; // medium
                        }
                        
                        const compressedImg = await compressImage(imgData, quality);
                        
                        // Get image dimensions
                        const img = new Image();
                        img.src = compressedImg;
                        
                        await new Promise((resolve) => {
                            img.onload = resolve;
                        });
                        
                        // Calculate dimensions to fit within maxWidth and maxHeight while maintaining aspect ratio
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            const ratio = maxWidth / width;
                            width = maxWidth;
                            height = height * ratio;
                        }
                        
                        if (height > maxHeight) {
                            const ratio = maxHeight / height;
                            height = maxHeight;
                            width = width * ratio;
                        }
                        
                        // Check if image will fit on current page
                        if (startY + height > doc.internal.pageSize.height - 20) {
                            startY = addContentPage('');
                        }
                        
                        // Center the image horizontally
                        const xPos = (doc.internal.pageSize.getWidth() - width) / 2;
                        
                        // Add image to PDF
                        doc.addImage(compressedImg, 'JPEG', xPos, startY, width, height);
                        
                        return startY + height + 10;
                    } catch (error) {
                        console.error('Error adding image to PDF:', error);
                        pdfStatus.value.error = 'Failed to add some images to the report';
                        return startY; // Skip this image but continue with the rest
                    }
                };

                // 1. Site Information
                if (!report.value.excludeEmpty || sectionHasData(siteInfo.value)) {
                    pdfStatus.value.progress = 20;
                    pdfStatus.value.message = 'Adding site information...';
                    
                    let yPos = addContentPage('1. Site Information');
                    
                    // Add site info table
                    const siteInfoData = [
                        { Field: 'Inspection Date', Value: formatDate(siteInfo.value.inspectionDate) },
                        { Field: 'Site Name/Location', Value: siteInfo.value.siteName },
                        { Field: 'Coordinates', Value: `${siteInfo.value.latitude}, ${siteInfo.value.longitude}` },
                        { Field: 'Client Name', Value: siteInfo.value.clientName },
                        { Field: 'Client Organization', Value: siteInfo.value.clientOrg },
                        { Field: 'Client Email', Value: siteInfo.value.clientEmail },
                        { Field: 'Client Phone', Value: siteInfo.value.clientPhone },
                        { Field: 'Site Description', Value: siteInfo.value.siteDescription || 'Not provided' }
                    ];
                    
                    yPos = addTableToPDF(['Field', 'Value'], siteInfoData, yPos);
                    
                    // Add photos if enabled and available
                    if (report.value.includePhotos && siteInfo.value.photos.length > 0) {
                        doc.setFontSize(12);
                        doc.text('Site Photos:', 20, yPos);
                        yPos += 7;
                        
                        // Add photos in rows of 2
                        for (let i = 0; i < siteInfo.value.photos.length; i++) {
                            if (i % 2 === 0 && i > 0) {
                                // Start new row after every 2 photos
                                yPos = await addImageToPDF(siteInfo.value.photos[i].url, yPos, 80, 60);
                            } else {
                                // Add photo to current row
                                const currentY = await addImageToPDF(siteInfo.value.photos[i].url, yPos, 80, 60);
                                if (i % 2 === 0) {
                                    // First photo in row, don't update yPos yet
                                    continue;
                                } else {
                                    // Second photo in row, update yPos
                                    yPos = currentY;
                                }
                            }
                            
                            pdfStatus.value.progress = 20 + (60 * 0.1 * (i + 1) / siteInfo.value.photos.length);
                        }
                    }
                }
                
                // 2. Ecological Assessment
                if (!report.value.excludeEmpty || sectionHasData(ecological.value)) {
                    pdfStatus.value.progress = 30;
                    pdfStatus.value.message = 'Adding ecological assessment...';
                    
                    let yPos = addContentPage('2. Ecological Assessment');
                    
                    // Add ecological assessment table
                    const ecoData = [
                        { Field: 'Vegetation Community', Value: ecological.value.vegetationCommunity || 'Not specified' },
                        { Field: 'Habitat Condition', Value: ecological.value.habitatCondition ? ecological.value.habitatCondition.charAt(0).toUpperCase() + ecological.value.habitatCondition.slice(1) : 'Not assessed' }
                    ];
                    
                    yPos = addTableToPDF(['Field', 'Value'], ecoData, yPos);
                    
                    // Add threatened species
                    doc.setFontSize(12);
                    doc.text('Threatened Species Present:', 20, yPos);
                    yPos += 7;
                    
                    const threatenedSpeciesList = Object.entries(ecological.value.threatenedSpecies)
                        .filter(([_, present]) => present)
                        .map(([species, _]) => species);
                        
                    if (threatenedSpeciesList.length > 0) {
                        doc.setFontSize(10);
                        threatenedSpeciesList.forEach(species => {
                            doc.text(`• ${species}`, 25, yPos);
                            yPos += 6;
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('None observed', 25, yPos);
                        yPos += 6;
                    }
                    yPos += 5;
                    
                    // Add invasive species
                    doc.setFontSize(12);
                    doc.text('Invasive Species/Weeds Present:', 20, yPos);
                    yPos += 7;
                    
                    const invasiveSpeciesList = Object.entries(ecological.value.invasiveSpecies)
                        .filter(([_, present]) => present)
                        .map(([weed, _]) => weed);
                        
                    if (invasiveSpeciesList.length > 0) {
                        doc.setFontSize(10);
                        invasiveSpeciesList.forEach(weed => {
                            doc.text(`• ${weed}`, 25, yPos);
                            yPos += 6;
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('None observed', 25, yPos);
                        yPos += 6;
                    }
                    yPos += 5;
                    
                    // Add ecological notes
                    doc.setFontSize(12);
                    doc.text('Ecological Notes:', 20, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(10);
                    const ecoNotesLines = doc.splitTextToSize(ecological.value.notes || 'No notes provided', 170);
                    doc.text(ecoNotesLines, 20, yPos);
                    yPos += (ecoNotesLines.length * 6) + 10;
                    
                    // Add photos if enabled and available
                    if (report.value.includePhotos && ecological.value.photos.length > 0) {
                        doc.setFontSize(12);
                        doc.text('Ecological Photos:', 20, yPos);
                        yPos += 7;
                        
                        // Add photos in rows of 2
                        for (let i = 0; i < ecological.value.photos.length; i++) {
                            if (i % 2 === 0 && i > 0) {
                                // Start new row after every 2 photos
                                yPos = await addImageToPDF(ecological.value.photos[i].url, yPos, 80, 60);
                            } else {
                                // Add photo to current row
                                const currentY = await addImageToPDF(ecological.value.photos[i].url, yPos, 80, 60);
                                if (i % 2 === 0) {
                                    // First photo in row, don't update yPos yet
                                    continue;
                                } else {
                                    // Second photo in row, update yPos
                                    yPos = currentY;
                                }
                            }
                            
                            pdfStatus.value.progress = 30 + (60 * 0.2 * (i + 1) / ecological.value.photos.length);
                        }
                    }
                }
                
                // 3. Cultural Heritage Assessment
                if (!report.value.excludeEmpty || sectionHasData(cultural.value)) {
                    pdfStatus.value.progress = 40;
                    pdfStatus.value.message = 'Adding cultural assessment...';
                    
                    let yPos = addContentPage('3. Cultural Heritage Assessment');
                    
                    // Add cultural assessment table
                    const culturalData = [
                        { Field: 'Heritage Register Status', Value: formatHeritageStatus(cultural.value.heritageRegister) },
                        { Field: 'Consultation with Traditional Owners', Value: formatConsultationStatus(cultural.value.consultation) }
                    ];
                    
                    yPos = addTableToPDF(['Field', 'Value'], culturalData, yPos);
                    
                    // Add known cultural features
                    doc.setFontSize(12);
                    doc.text('Known Cultural Features:', 20, yPos);
                    yPos += 7;
                    
                    const culturalFeaturesList = Object.entries(cultural.value.knownFeatures)
                        .filter(([_, present]) => present)
                        .map(([feature, _]) => feature);
                        
                    if (culturalFeaturesList.length > 0) {
                        doc.setFontSize(10);
                        culturalFeaturesList.forEach(feature => {
                            doc.text(`• ${feature}`, 25, yPos);
                            yPos += 6;
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('None observed', 25, yPos);
                        yPos += 6;
                    }
                    yPos += 5;
                    
                    // Add cultural significance
                    doc.setFontSize(12);
                    doc.text('Cultural Significance Assessment:', 20, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(10);
                    const culturalSigLines = doc.splitTextToSize(cultural.value.significance || 'No significance assessment provided', 170);
                    doc.text(culturalSigLines, 20, yPos);
                    yPos += (culturalSigLines.length * 6) + 10;
                    
                    // Add cultural notes
                    doc.setFontSize(12);
                    doc.text('Cultural Heritage Notes:', 20, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(10);
                    const culturalNotesLines = doc.splitTextToSize(cultural.value.notes || 'No notes provided', 170);
                    doc.text(culturalNotesLines, 20, yPos);
                    yPos += (culturalNotesLines.length * 6) + 10;
                    
                    // Add photos if enabled and available
                    if (report.value.includePhotos && cultural.value.photos.length > 0) {
                        doc.setFontSize(12);
                        doc.text('Cultural Heritage Photos:', 20, yPos);
                        yPos += 7;
                        
                        // Add photos in rows of 2
                        for (let i = 0; i < cultural.value.photos.length; i++) {
                            if (i % 2 === 0 && i > 0) {
                                // Start new row after every 2 photos
                                yPos = await addImageToPDF(cultural.value.photos[i].url, yPos, 80, 60);
                            } else {
                                // Add photo to current row
                                const currentY = await addImageToPDF(cultural.value.photos[i].url, yPos, 80, 60);
                                if (i % 2 === 0) {
                                    // First photo in row, don't update yPos yet
                                    continue;
                                } else {
                                    // Second photo in row, update yPos
                                    yPos = currentY;
                                }
                            }
                            
                            pdfStatus.value.progress = 40 + (60 * 0.2 * (i + 1) / cultural.value.photos.length);
                        }
                    }
                }
                
                // 4. Risk Assessment
                if (!report.value.excludeEmpty || sectionHasData(riskAssessment.value)) {
                    pdfStatus.value.progress = 50;
                    pdfStatus.value.message = 'Adding risk assessment...';
                    
                    let yPos = addContentPage('4. Risk Assessment');
                    
                    // Add risk assessment table
                    const riskData = [
                        { Field: 'Soil Condition', Value: riskAssessment.value.soilCondition ? riskAssessment.value.soilCondition.charAt(0).toUpperCase() + riskAssessment.value.soilCondition.slice(1) : 'Not assessed' },
                        { Field: 'Erosion Risk', Value: riskAssessment.value.erosionRisk ? riskAssessment.value.erosionRisk.charAt(0).toUpperCase() + riskAssessment.value.erosionRisk.slice(1) : 'Not assessed' },
                        { Field: 'Disturbance Level', Value: riskAssessment.value.disturbanceLevel ? riskAssessment.value.disturbanceLevel.charAt(0).toUpperCase() + riskAssessment.value.disturbanceLevel.slice(1) : 'Not assessed' },
                        { Field: 'Overall Risk Level', Value: riskAssessment.value.riskLevel ? riskAssessment.value.riskLevel.charAt(0).toUpperCase() + riskAssessment.value.riskLevel.slice(1) : 'Not assessed' }
                    ];
                    
                    yPos = addTableToPDF(['Field', 'Value'], riskData, yPos);
                    
                    // Add hazards
                    doc.setFontSize(12);
                    doc.text('Hazards Present:', 20, yPos);
                    yPos += 7;
                    
                    const hazardsList = Object.entries(riskAssessment.value.hazards)
                        .filter(([_, present]) => present)
                        .map(([hazard, _]) => hazard);
                        
                    if (hazardsList.length > 0) {
                        doc.setFontSize(10);
                        hazardsList.forEach(hazard => {
                            doc.text(`• ${hazard}`, 25, yPos);
                            yPos += 6;
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('None observed', 25, yPos);
                        yPos += 6;
                    }
                    yPos += 5;
                    
                    // Add risk notes
                    doc.setFontSize(12);
                    doc.text('Risk Assessment Notes:', 20, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(10);
                    const riskNotesLines = doc.splitTextToSize(riskAssessment.value.notes || 'No notes provided', 170);
                    doc.text(riskNotesLines, 20, yPos);
                    yPos += (riskNotesLines.length * 6) + 10;
                    
                    // Add photos if enabled and available
                    if (report.value.includePhotos && riskAssessment.value.photos.length > 0) {
                        doc.setFontSize(12);
                        doc.text('Risk Photos:', 20, yPos);
                        yPos += 7;
                        
                        // Add photos in rows of 2
                        for (let i = 0; i < riskAssessment.value.photos.length; i++) {
                            if (i % 2 === 0 && i > 0) {
                                // Start new row after every 2 photos
                                yPos = await addImageToPDF(riskAssessment.value.photos[i].url, yPos, 80, 60);
                            } else {
                                // Add photo to current row
                                const currentY = await addImageToPDF(riskAssessment.value.photos[i].url, yPos, 80, 60);
                                if (i % 2 === 0) {
                                    // First photo in row, don't update yPos yet
                                    continue;
                                } else {
                                    // Second photo in row, update yPos
                                    yPos = currentY;
                                }
                            }
                            
                            pdfStatus.value.progress = 50 + (60 * 0.2 * (i + 1) / riskAssessment.value.photos.length);
                        }
                    }
                }
                
                // 5. Recommended Mitigation Actions
                if (!report.value.excludeEmpty || sectionHasData(mitigation.value)) {
                    pdfStatus.value.progress = 60;
                    pdfStatus.value.message = 'Adding mitigation recommendations...';
                    
                    let yPos = addContentPage('5. Recommended Mitigation Actions');
                    
                    // Add ecological mitigation
                    doc.setFontSize(12);
                    doc.text('Ecological Mitigation Measures:', 20, yPos);
                    yPos += 7;
                    
                    const ecoMitigationList = Object.entries(mitigation.value.ecologicalMeasures)
                        .filter(([_, selected]) => selected)
                        .map(([measure, _]) => measure);
                        
                    if (ecoMitigationList.length > 0) {
                        doc.setFontSize(10);
                        ecoMitigationList.forEach(measure => {
                            doc.text(`• ${measure}`, 25, yPos);
                            yPos += 6;
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('None recommended', 25, yPos);
                        yPos += 6;
                    }
                    yPos += 5;
                    
                    // Add ecological mitigation details
                    if (mitigation.value.ecologicalDetails) {
                        doc.setFontSize(12);
                        doc.text('Ecological Mitigation Details:', 20, yPos);
                        yPos += 7;
                        
                        doc.setFontSize(10);
                        const ecoMitDetailsLines = doc.splitTextToSize(mitigation.value.ecologicalDetails, 170);
                        doc.text(ecoMitDetailsLines, 20, yPos);
                        yPos += (ecoMitDetailsLines.length * 6) + 10;
                    }
                    
                    // Add cultural mitigation
                    doc.setFontSize(12);
                    doc.text('Cultural Heritage Mitigation Measures:', 20, yPos);
                    yPos += 7;
                    
                    const culturalMitigationList = Object.entries(mitigation.value.culturalMeasures)
                        .filter(([_, selected]) => selected)
                        .map(([measure, _]) => measure);
                        
                    if (culturalMitigationList.length > 0) {
                        doc.setFontSize(10);
                        culturalMitigationList.forEach(measure => {
                            doc.text(`• ${measure}`, 25, yPos);
                            yPos += 6;
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('None recommended', 25, yPos);
                        yPos += 6;
                    }
                    yPos += 5;
                    
                    // Add cultural mitigation details
                    if (mitigation.value.culturalDetails) {
                        doc.setFontSize(12);
                        doc.text('Cultural Mitigation Details:', 20, yPos);
                        yPos += 7;
                        
                        doc.setFontSize(10);
                        const culturalMitDetailsLines = doc.splitTextToSize(mitigation.value.culturalDetails, 170);
                        doc.text(culturalMitDetailsLines, 20, yPos);
                        yPos += (culturalMitDetailsLines.length * 6) + 10;
                    }
                    
                    // Add general mitigation
                    doc.setFontSize(12);
                    doc.text('General Site Mitigation Measures:', 20, yPos);
                    yPos += 7;
                    
                    const generalMitigationList = Object.entries(mitigation.value.generalMeasures)
                        .filter(([_, selected]) => selected)
                        .map(([measure, _]) => measure);
                        
                    if (generalMitigationList.length > 0) {
                        doc.setFontSize(10);
                        generalMitigationList.forEach(measure => {
                            doc.text(`• ${measure}`, 25, yPos);
                            yPos += 6;
                        });
                    } else {
                        doc.setFontSize(10);
                        doc.text('None recommended', 25, yPos);
                        yPos += 6;
                    }
                    yPos += 5;
                    
                    // Add general mitigation details
                    if (mitigation.value.generalDetails) {
                        doc.setFontSize(12);
                        doc.text('General Mitigation Details:', 20, yPos);
                        yPos += 7;
                        
                        doc.setFontSize(10);
                        const generalMitDetailsLines = doc.splitTextToSize(mitigation.value.generalDetails, 170);
                        doc.text(generalMitDetailsLines, 20, yPos);
                        yPos += (generalMitDetailsLines.length * 6) + 10;
                    }
                    
                    // Add monitoring requirements
                    doc.setFontSize(12);
                    doc.text('Monitoring Requirements:', 20, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(10);
                    const monitoringLines = doc.splitTextToSize(mitigation.value.monitoring || 'None specified', 170);
                    doc.text(monitoringLines, 20, yPos);
                    yPos += (monitoringLines.length * 6) + 10;
                }
                
                // 6. Inspector Details
                pdfStatus.value.progress = 80;
                pdfStatus.value.message = 'Adding inspector details...';
                
                let yPos = addContentPage('6. Inspector Details');
                
                // Add inspector details table
                const inspectorData = [
                    { Field: 'Inspector Name', Value: report.value.inspectorName || 'Not provided' },
                    { Field: 'Organization', Value: report.value.inspectorOrg || 'Not provided' },
                    { Field: 'Qualifications', Value: report.value.inspectorQualifications || 'Not provided' }
                ];
                
                yPos = addTableToPDF(['Field', 'Value'], inspectorData, yPos);
                
                // Add signature if available
                if (report.value.signatureData) {
                    doc.setFontSize(12);
                    doc.text('Inspector Signature:', 20, yPos);
                    yPos += 7;
                    
                    const img = new Image();
                    img.src = report.value.signatureData;
                    
                    await new Promise((resolve) => {
                        img.onload = resolve;
                    });
                    
                    // Calculate dimensions to fit within maxWidth while maintaining aspect ratio
                    const maxWidth = 100;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        const ratio = maxWidth / width;
                        width = maxWidth;
                        height = height * ratio;
                    }
                    
                    // Add signature to PDF
                    doc.addImage(report.value.signatureData, 'PNG', 20, yPos, width, height);
                    yPos += height + 10;
                }
                
                // Add report notes if available
                if (report.value.notes) {
                    doc.setFontSize(12);
                    doc.text('Additional Report Notes:', 20, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(10);
                    const reportNotesLines = doc.splitTextToSize(report.value.notes, 170);
                    doc.text(reportNotesLines, 20, yPos);
                    yPos += (reportNotesLines.length * 6) + 10;
                }
                
                // Update table of contents with page numbers if enabled
                if (report.value.tableOfContents) {
                    pdfStatus.value.progress = 90;
                    pdfStatus.value.message = 'Finalizing report...';
                    
                    // Go back to the TOC page and add page numbers
                    doc.setPage(2);
                    
                    let tocPageNumbers = [3]; // Page numbers for each section
                    let currentPageNum = 3;
                    
                    // Calculate page numbers for each section
                    if (!report.value.excludeEmpty || sectionHasData(siteInfo.value)) {
                        currentPageNum += 1; // Site info starts on next page
                        tocPageNumbers.push(currentPageNum);
                        
                        // Estimate additional pages for site info (1 base + photos)
                        const photoPages = report.value.includePhotos ? Math.ceil(siteInfo.value.photos.length / 4) : 0;
                        currentPageNum += 1 + photoPages;
                    } else {
                        tocPageNumbers.push(currentPageNum);
                    }
                    
                    if (!report.value.excludeEmpty || sectionHasData(ecological.value)) {
                        currentPageNum += 1;
                        tocPageNumbers.push(currentPageNum);
                        
                        const photoPages = report.value.includePhotos ? Math.ceil(ecological.value.photos.length / 4) : 0;
                        currentPageNum += 1 + photoPages;
                    } else {
                        tocPageNumbers.push(currentPageNum);
                    }
                    
                    if (!report.value.excludeEmpty || sectionHasData(cultural.value)) {
                        currentPageNum += 1;
                        tocPageNumbers.push(currentPageNum);
                        
                        const photoPages = report.value.includePhotos ? Math.ceil(cultural.value.photos.length / 4) : 0;
                        currentPageNum += 1 + photoPages;
                    } else {
                        tocPageNumbers.push(currentPageNum);
                    }
                    
                    if (!report.value.excludeEmpty || sectionHasData(riskAssessment.value)) {
                        currentPageNum += 1;
                        tocPageNumbers.push(currentPageNum);
                        
                        const photoPages = report.value.includePhotos ? Math.ceil(riskAssessment.value.photos.length / 4) : 0;
                        currentPageNum += 1 + photoPages;
                    } else {
                        tocPageNumbers.push(currentPageNum);
                    }
                    
                    if (!report.value.excludeEmpty || sectionHasData(mitigation.value)) {
                        currentPageNum += 1;
                        tocPageNumbers.push(currentPageNum);
                    } else {
                        tocPageNumbers.push(currentPageNum);
                    }
                    
                    // Add the page numbers to the TOC
                    doc.setFontSize(12);
                    doc.setTextColor('#000000');
                    
                    let tocYPos = 30;
                    for (let i = 0; i < tocPageNumbers.length; i++) {
                        doc.text(tocPageNumbers[i].toString(), 180, tocYPos, { align: 'right' });
                        tocYPos += 7;
                    }
                }
                
                // Add footer to all pages except cover if enabled
                if (report.value.headerFooter) {
                    const pageCount = doc.internal.getNumberOfPages();
                    
                    for (let i = 2; i <= pageCount; i++) { // Start from page 2 (skip cover)
                        doc.setPage(i);
                        
                        // Footer line
                        doc.setDrawColor(200, 200, 200);
                        doc.line(20, 280, 190, 280);
                        
                        // Footer text
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Generated on ${new Date().toLocaleString()}`, 20, 285);
                        doc.text('Confidential - For client use only', 105, 285, { align: 'center' });
                        if (report.value.pageNumbers) {
                            doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
                        }
                    }
                }
                
                // Save the PDF
                pdfStatus.value.progress = 100;
                pdfStatus.value.message = 'Report generated successfully!';
                
                const fileName = `SiteInspectionReport_${siteInfo.value.siteName || 'UnnamedSite'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                // Reset status after a delay
                setTimeout(() => {
                    pdfStatus.value.active = false;
                }, 3000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                pdfStatus.value.error = 'An error occurred while generating the PDF. Please try again.';
                pdfStatus.value.progress = 0;
            }
        };
        
        const finishInspection = () => {
            if (confirm('Are you ready to finish this inspection? You can save your progress and return later if needed.')) {
                // In a real implementation, this might submit the data to a server
                alert('Inspection completed successfully! You can now generate your final report.');
                activeTab.value = 5; // Go to report tab
            }
        };
        
        return {
            darkMode,
            toggleTheme,
            learnerMode,
            tabs,
            activeTab,
            prevTab,
            nextTab,
            validateAndNextTab,
            progress,
            siteInfo,
            coordErrors,
            validateCoordinates,
            vegetationCommunities,
            threatenedSpecies,
            invasiveSpecies,
            ecological,
            addThreatenedSpecies,
            addInvasiveSpecies,
            culturalFeatures,
            cultural,
            getFeatureDescription,
            addCulturalFeature,
            hazards,
            riskAssessment,
            addHazard,
            riskMatrix,
            ecologicalMitigation,
            culturalMitigation,
            generalMitigation,
            mitigation,
            addEcologicalMitigation,
            addCulturalMitigation,
            addGeneralMitigation,
            report,
            pdfStatus,
            photoModal,
            viewPhoto,
            triggerPhotoUpload,
            handlePhotoUpload,
            removePhoto,
            locateUser,
            signaturePad,
            clearSignature,
            quizAnswers,
            saveInspection,
            loadInspection,
            formatDate,
            formatHeritageStatus,
            formatConsultationStatus,
            generatePDF,
            finishInspection
        };
    }
}).mount('#app');
    </script>
</body>
</html>
